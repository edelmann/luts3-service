#!/usr/bin/python

"""
A tool for managing hostscalingfactors in the SGAS db.

Author: Erik Edelmann <edelmann@csc.fi>
Copyright NeIC 2016
"""

import argparse
import psycopg2
import datetime
import sys

from sgas.server import config


DEFAULT_POSTGRESQL_PORT = 5432

NOW = datetime.datetime.now()
EPOCH = '1970-01-01 00:00:00'


def connectDb(dbstring):
    args = [ e or None for e in dbstring.split(':') ]
    host, port, database, user, password = args[:5]

    if port is None:
        port = DEFAULT_POSTGRESQL_PORT

    try:
        return psycopg2.connect(host=host, port=port, database=database, user=user, password=password)
    except psycopg2.Error as e:
        print "DB Error: %s" % e
    sys.exit(1)



def show_factors(db, machine_name, time):
    query = """
        SELECT DISTINCT ON (machine_name) machine_name, scale_factor, from_time
        FROM hostscalefactors
        WHERE %s from_time <= '%s'
        ORDER BY machine_name, from_time DESC;
        """

    if machine_name:
        machine_requirement = "machine_name = '%s' AND" % machine_name
    else:
        machine_requirement = ""

    if not time:
        time = NOW.isoformat()

    try:
        cur = db.cursor()
        cur.execute(query % (machine_requirement, time))
    except psycopg2.Error as e:
        sys.stderr.write("DB Error: %s\n" % e)
        sys.exit(1)

    for row in cur.fetchall():
        machine_name = row[0]
        scalefactor = row[1]
        time = row[2]
        print "%-40s  %7s    %s" % (machine_name, scalefactor, time)


def set_factor(db, machine_name, time, factor):

    if not machine_name:
        sys.stderr.write("ERROR: Machine_name must be given for action 'set'!\n")
        sys.exit(1)

    if not factor:
        sys.stderr.write("ERROR: A scale factor must be given for action 'set'!\n")
        sys.exit(1)

    cur = db.cursor()

    if not time:
        # Use NOW by default, unless this is the first scale factor for this
        # machine, in which case we use the Epoch instead.
        try:
            cur.execute("SELECT count(*) FROM hostscalefactors WHERE machine_name = '%s';" % machine_name)
        except psycopg2.Error as e:
            sys.stderr.write("DB Error: %s\n" % e)
            sys.exit(1)
        row = cur.fetchone()

        if row[0] > 0:
            time = NOW.isoformat()
        else:
            time = EPOCH

    sql = "INSERT INTO hostscalefactors (machine_name, from_time, scale_factor) VALUES ('%s', '%s', %s);" \
        % (machine_name, time, factor)
    try:
        cur.execute(sql)
        db.commit()
    except psycopg2.Error as e:
        sys.stderr.write("DB Error: %s\n" % e)
        sys.exit(1)


def del_factors(db, machine_name, time):

    if not machine_name:
        sys.stderr.write("ERROR: Machine_name must be given for action 'del'!\n")
        sys.exit(1)

    condition = "WHERE machine_name = '%s'" % machine_name

    if time:
        condition += " AND from_time = '%s'" % time

    print "These host scale factors will be deleted:\n"
    try:
        cur = db.cursor()
        cur.execute("SELECT * FROM hostscalefactors %s;" % condition)
    except psycopg2.Error as e:
        sys.stderr.write("DB Error: %s\n" % e)
        sys.exit(1)
    for row in cur.fetchall():
        machine_name = row[0]
        scalefactor = row[1]
        time = row[2]
        print "%-40s  %7s    %s" % (machine_name, scalefactor, time)
    print "\nProceed (y/n)?"
    response = sys.stdin.readline()

    if response not in ('y\n', 'Y\n'):
        print "Aborting. Nothing deleted"
        sys.exit(0)

    try:
        cur.execute("DELETE FROM hostscalefactors %s;" % condition)
        db.commit()
    except psycopg2.Error as e:
        sys.stderr.write("DB Error: %s\n" % e)
        sys.exit(1)



def main():
    argparser = argparse.ArgumentParser(description='Manage hostscaling factors in SGAS')
    argparser.add_argument('action', choices=['set', 'show', 'del'], help='Action')
    argparser.add_argument('machine_name', nargs='?', help="Machine name")
    argparser.add_argument('factor', nargs='?', help="Scale factor")
    argparser.add_argument('-t', '--time', help="Time in format YYYY-MM-DD[ hh:mm:ss]")
    argparser.add_argument('-c', '--conf', help="SGAS config file (default: /etc/sgas.conf)", default="/etc/sgas.conf")

    args = argparser.parse_args()

    cfg = config.readConfig(args.conf)
    db = connectDb(cfg.get(config.SERVER_BLOCK,config.DB))

    if args.action == 'show':
        show_factors(db, args.machine_name, args.time)
    elif args.action == 'set':
        set_factor(db, args.machine_name, args.time, args.factor)
    elif args.action == 'del':
        del_factors(db, args.machine_name, args.time)
    else:
        raise Exception("Huh?  We should never end up here!")


if __name__ == "__main__":
    main()
